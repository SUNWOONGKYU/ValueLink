<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²°ì œí•˜ê¸° | ValueLink</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --deep-blue: #1D4ED8;
            --deep-green: #166534;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --white: #FFFFFF;
            --border: #E5E7EB;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #F9FAFB;
            color: var(--text-primary);
        }

        /* Container */
        .container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
            gap: 40px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .page-description {
            font-size: 16px;
            color: var(--text-secondary);
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .card h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        /* Project Info Card */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .info-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .project-id {
            font-family: 'Consolas', 'Monaco', monospace;
            color: var(--deep-blue);
        }

        /* Final Report Preview */
        .report-preview {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: #F9FAFB;
            border: 2px solid var(--border);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .report-info {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }

        .report-icon {
            font-size: 40px;
        }

        .report-details {
            flex: 1;
        }

        .report-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .report-meta {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .btn-view-report {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            color: var(--deep-blue);
            background: white;
            border: 2px solid var(--deep-blue);
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .btn-view-report:hover {
            background: var(--deep-blue);
            color: white;
        }

        /* Payment Summary */
        .payment-summary {
            background: #F9FAFB;
            border-radius: 12px;
            padding: 24px;
            margin-top: 16px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .summary-row:last-child {
            border-bottom: none;
            padding-top: 16px;
            margin-top: 8px;
        }

        .summary-label {
            font-size: 15px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .summary-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-row.total .summary-label {
            font-size: 18px;
            color: var(--text-primary);
        }

        .summary-row.total .summary-value {
            font-size: 28px;
            color: var(--deep-blue);
        }

        /* Payment Method Selection */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .payment-method {
            position: relative;
        }

        .payment-method input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .payment-method label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .payment-method input[type="radio"]:checked + label {
            border-color: var(--deep-blue);
            background: #EFF6FF;
        }

        .payment-method-icon {
            font-size: 24px;
        }

        .payment-method-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Payment Form */
        .payment-form {
            margin-top: 24px;
            padding: 24px;
            background: #F9FAFB;
            border-radius: 12px;
            display: none;
        }

        .payment-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--deep-blue);
            box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 12px;
        }

        /* Bank Account Info */
        .bank-info {
            padding: 20px;
            background: white;
            border: 2px solid var(--deep-blue);
            border-radius: 12px;
        }

        .bank-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .bank-row:last-child {
            margin-bottom: 0;
        }

        .bank-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .bank-value {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .copy-button {
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 600;
            color: var(--deep-blue);
            background: white;
            border: 1px solid var(--deep-blue);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .copy-button:hover {
            background: var(--deep-blue);
            color: white;
        }

        /* Terms and Agreements */
        .terms-section {
            margin-top: 16px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-label {
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
        }

        .checkbox-label.required::after {
            content: ' *';
            color: var(--danger);
        }

        .terms-link {
            color: var(--deep-blue);
            text-decoration: underline;
            cursor: pointer;
        }

        .terms-link:hover {
            color: #1E40AF;
        }

        /* Payment Button */
        .btn-payment {
            width: 100%;
            padding: 18px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            background: var(--deep-blue);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 24px;
        }

        .btn-payment:hover:not(:disabled) {
            background: #1E40AF;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(29, 78, 216, 0.4);
        }

        .btn-payment:disabled {
            background: #D1D5DB;
            cursor: not-allowed;
        }

        /* Security Notice */
        .security-notice {
            margin-top: 24px;
            padding: 16px;
            background: #ECFDF5;
            border: 1px solid #10B981;
            border-radius: 12px;
            text-align: center;
        }

        .security-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .security-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .pg-logos {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .pg-logo {
            padding: 8px 16px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #E5E7EB;
            border-top-color: var(--deep-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 15px;
            color: var(--text-secondary);
        }

        /* Sidebar */
        .sidebar-wrapper {
            width: 320px;
            flex-shrink: 0;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }

            .sidebar-wrapper {
                width: 100%;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .payment-methods {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div id="header-container"></div>

    <div class="container">
        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">ê²°ì œí•˜ê¸°</h1>
                <p class="page-description">í‰ê°€ë³´ê³ ì„œ ë¹„ìš©ì„ ê²°ì œí•˜ì‹œë©´ ìµœì¢… ë³´ê³ ì„œë¥¼ ìˆ˜ë ¹í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <!-- ë¡œë”© ìƒíƒœ -->
            <div id="loadingState" class="loading">
                <div class="loading-spinner"></div>
                <p class="loading-text">ê²°ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>

            <!-- í”„ë¡œì íŠ¸ ì •ë³´ -->
            <div id="projectInfoCard" class="card" style="display: none;">
                <h3>í”„ë¡œì íŠ¸ ì •ë³´</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">í”„ë¡œì íŠ¸ ë²ˆí˜¸</span>
                        <span class="info-value project-id" id="projectIdDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">íšŒì‚¬ëª…</span>
                        <span class="info-value" id="companyNameDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">í‰ê°€ë²•</span>
                        <span class="info-value" id="methodDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">í‰ê°€ ê¸°ì¤€ì¼</span>
                        <span class="info-value" id="valuationDateDisplay">-</span>
                    </div>
                </div>
            </div>

            <!-- ìµœì¢…ì•ˆ ë¯¸ë¦¬ë³´ê¸° -->
            <div id="reportPreviewCard" class="card" style="display: none;">
                <h3>í‰ê°€ë³´ê³ ì„œ ìµœì¢…ì•ˆ</h3>
                <div class="report-preview">
                    <div class="report-info">
                        <span class="report-icon">ğŸ“„</span>
                        <div class="report-details">
                            <div class="report-title">í‰ê°€ë³´ê³ ì„œ ìµœì¢…ì•ˆ.pdf</div>
                            <div class="report-meta">45í˜ì´ì§€ â€¢ 2.3MB</div>
                        </div>
                    </div>
                    <a href="#" class="btn-view-report" id="btnViewReport">ìµœì¢…ì•ˆ ë‹¤ì‹œ ë³´ê¸°</a>
                </div>
            </div>

            <!-- ê²°ì œ ê¸ˆì•¡ -->
            <div id="paymentSummaryCard" class="card" style="display: none;">
                <h3>ê²°ì œ ê¸ˆì•¡</h3>
                <div class="payment-summary">
                    <div class="summary-row">
                        <span class="summary-label">í‰ê°€ ì„œë¹„ìŠ¤</span>
                        <span class="summary-value" id="serviceName">-</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">í‰ê°€ ê¸ˆì•¡</span>
                        <span class="summary-value" id="baseAmount">-</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">ë¶€ê°€ì„¸ (VAT 10%)</span>
                        <span class="summary-value" id="vatAmount">-</span>
                    </div>
                    <div class="summary-row total">
                        <span class="summary-label">ì´ ê²°ì œ ê¸ˆì•¡</span>
                        <span class="summary-value" id="totalAmount">-</span>
                    </div>
                </div>
            </div>

            <!-- ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ -->
            <div id="paymentMethodCard" class="card" style="display: none;">
                <h3>ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ</h3>
                <div class="payment-methods">
                    <div class="payment-method">
                        <input type="radio" name="paymentMethod" id="methodCard" value="card">
                        <label for="methodCard">
                            <span class="payment-method-icon">ğŸ’³</span>
                            <span class="payment-method-name">ì‹ ìš©ì¹´ë“œ</span>
                        </label>
                    </div>
                    <div class="payment-method">
                        <input type="radio" name="paymentMethod" id="methodBank" value="bank">
                        <label for="methodBank">
                            <span class="payment-method-icon">ğŸ¦</span>
                            <span class="payment-method-name">ë¬´í†µì¥ ì…ê¸ˆ</span>
                        </label>
                    </div>
                    <div class="payment-method">
                        <input type="radio" name="paymentMethod" id="methodTransfer" value="transfer">
                        <label for="methodTransfer">
                            <span class="payment-method-icon">ğŸ’°</span>
                            <span class="payment-method-name">ê³„ì¢Œì´ì²´</span>
                        </label>
                    </div>
                    <div class="payment-method">
                        <input type="radio" name="paymentMethod" id="methodEasy" value="easy">
                        <label for="methodEasy">
                            <span class="payment-method-icon">ğŸ“±</span>
                            <span class="payment-method-name">ê°„í¸ê²°ì œ</span>
                        </label>
                    </div>
                </div>

                <!-- ì‹ ìš©ì¹´ë“œ í¼ -->
                <div id="formCard" class="payment-form">
                    <div class="form-group">
                        <label class="form-label">ì¹´ë“œë²ˆí˜¸</label>
                        <div class="form-row">
                            <input type="text" class="form-input" placeholder="1234-5678-9012-3456" maxlength="19">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label class="form-label">ìœ íš¨ê¸°ê°„</label>
                                <input type="text" class="form-input" placeholder="MM/YY" maxlength="5">
                            </div>
                            <div>
                                <label class="form-label">CVC</label>
                                <input type="text" class="form-input" placeholder="123" maxlength="3">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì¹´ë“œ ì†Œìœ ìëª…</label>
                        <input type="text" class="form-input" placeholder="í™ê¸¸ë™">
                    </div>
                </div>

                <!-- ë¬´í†µì¥ ì…ê¸ˆ -->
                <div id="formBank" class="payment-form">
                    <div class="bank-info">
                        <div class="bank-row">
                            <span class="bank-label">ì€í–‰ëª…</span>
                            <span class="bank-value">êµ­ë¯¼ì€í–‰</span>
                        </div>
                        <div class="bank-row">
                            <span class="bank-label">ê³„ì¢Œë²ˆí˜¸</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span class="bank-value" id="accountNumber">123-456-789012</span>
                                <button class="copy-button" onclick="copyAccountNumber()">ë³µì‚¬</button>
                            </div>
                        </div>
                        <div class="bank-row">
                            <span class="bank-label">ì˜ˆê¸ˆì£¼</span>
                            <span class="bank-value">(ì£¼)ë°¸ë¥˜ë§í¬</span>
                        </div>
                        <div class="bank-row">
                            <span class="bank-label">ì…ê¸ˆ ê¸ˆì•¡</span>
                            <span class="bank-value" id="depositAmount">-</span>
                        </div>
                    </div>
                    <p style="margin-top: 16px; font-size: 14px; color: var(--text-secondary);">
                        ì…ê¸ˆìëª…ì€ íšŒì‚¬ëª…ìœ¼ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”. ì…ê¸ˆ í™•ì¸ í›„ ìµœì¢… ë³´ê³ ì„œê°€ ë°œì†¡ë©ë‹ˆë‹¤.
                    </p>
                </div>

                <!-- ê³„ì¢Œì´ì²´ -->
                <div id="formTransfer" class="payment-form">
                    <div class="bank-info">
                        <div class="bank-row">
                            <span class="bank-label">ê°€ìƒê³„ì¢Œ ë°œê¸‰</span>
                            <span class="bank-value">ìë™ ë°œê¸‰ë©ë‹ˆë‹¤</span>
                        </div>
                    </div>
                    <p style="margin-top: 16px; font-size: 14px; color: var(--text-secondary);">
                        ê²°ì œ ì§„í–‰ ì‹œ ê³ ê°ë‹˜ ì „ìš© ê°€ìƒê³„ì¢Œê°€ ë°œê¸‰ë©ë‹ˆë‹¤. ë°œê¸‰ëœ ê³„ì¢Œë¡œ ì…ê¸ˆí•´ ì£¼ì„¸ìš”.
                    </p>
                </div>

                <!-- ê°„í¸ê²°ì œ -->
                <div id="formEasy" class="payment-form">
                    <div class="payment-methods" style="margin-top: 0;">
                        <div class="payment-method">
                            <input type="radio" name="easyPayMethod" id="kakao" value="kakao">
                            <label for="kakao">
                                <span class="payment-method-icon">ğŸ’›</span>
                                <span class="payment-method-name">ì¹´ì¹´ì˜¤í˜ì´</span>
                            </label>
                        </div>
                        <div class="payment-method">
                            <input type="radio" name="easyPayMethod" id="naver" value="naver">
                            <label for="naver">
                                <span class="payment-method-icon">ğŸ’š</span>
                                <span class="payment-method-name">ë„¤ì´ë²„í˜ì´</span>
                            </label>
                        </div>
                        <div class="payment-method">
                            <input type="radio" name="easyPayMethod" id="toss" value="toss">
                            <label for="toss">
                                <span class="payment-method-icon">ğŸ’™</span>
                                <span class="payment-method-name">í† ìŠ¤í˜ì´</span>
                            </label>
                        </div>
                        <div class="payment-method">
                            <input type="radio" name="easyPayMethod" id="payco" value="payco">
                            <label for="payco">
                                <span class="payment-method-icon">â¤ï¸</span>
                                <span class="payment-method-name">í˜ì´ì½”</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- ì•½ê´€ ë™ì˜ -->
                <div class="terms-section">
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="termsPayment" required>
                            <label for="termsPayment" class="checkbox-label required">
                                ê²°ì œ ëŒ€í–‰ ì„œë¹„ìŠ¤ ì•½ê´€ ë™ì˜
                                <a href="#" class="terms-link" onclick="showTerms('payment'); return false;">(ì „ë¬¸ë³´ê¸°)</a>
                            </label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="termsPrivacy" required>
                            <label for="termsPrivacy" class="checkbox-label required">
                                ê°œì¸ì •ë³´ ì œ3ì ì œê³µ ë™ì˜
                                <a href="#" class="terms-link" onclick="showTerms('privacy'); return false;">(ì „ë¬¸ë³´ê¸°)</a>
                            </label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="termsRefund" required>
                            <label for="termsRefund" class="checkbox-label required">
                                í™˜ë¶ˆ ê·œì • í™•ì¸
                                <a href="#" class="terms-link" onclick="showTerms('refund'); return false;">(ì „ë¬¸ë³´ê¸°)</a>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- ê²°ì œ ë²„íŠ¼ -->
                <button id="btnPay" class="btn-payment" disabled>ê²°ì œí•˜ê¸°</button>

                <!-- ë³´ì•ˆ ì•ˆë‚´ -->
                <div class="security-notice">
                    <div class="security-icon">ğŸ”’</div>
                    <p class="security-text">SSL ë³´ì•ˆ ê²°ì œë¡œ ì•ˆì „í•˜ê²Œ ë³´í˜¸ë©ë‹ˆë‹¤</p>
                    <div class="pg-logos">
                        <span class="pg-logo">KGì´ë‹ˆì‹œìŠ¤</span>
                        <span class="pg-logo">í† ìŠ¤í˜ì´ë¨¼ì¸ </span>
                        <span class="pg-logo">NICEí˜ì´ë¨¼ì¸ </span>
                    </div>
                </div>
            </div>
        </main>

        <!-- ì‚¬ì´ë“œë°” -->
        <aside id="sidebar-container" class="sidebar-wrapper">
            <!-- ê³µí†µ ì‚¬ì´ë“œë°” ì»´í¬ë„ŒíŠ¸ ì£¼ì… -->
        </aside>
    </div>

    <!-- í—¤ë” ë¡œë“œ -->
    <script>
        fetch('../components/header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
                const scripts = document.getElementById('header-container').querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    document.body.appendChild(newScript);
                });
            })
            .catch(error => console.error('í—¤ë” ë¡œë“œ ì‹¤íŒ¨:', error));
    </script>

    <!-- í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        import { injectSidebar } from '../components/common-sidebar.js';
        import { checkMethodStatus, METHOD_NAMES, STATUS } from '../components/project-status-checker.js';

        // Supabase í´ë¼ì´ì–¸íŠ¸
        const SUPABASE_URL = 'https://arxrfetgaitkgiiqabap.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyeHJmZXRnYWl0a2dpaXFhYmFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk1OTgsImV4cCI6MjA4NDM2NTU5OH0.BTnuv0sYr2MGe1c-gk8PWCviwkFyIiymfKp5Jhzwbo0';
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // í‰ê°€ë²•ë³„ ê°€ê²© (ì›)
        const METHOD_PRICES = {
            dcf: 3000000,              // 300ë§Œì›
            relative: 2500000,         // 250ë§Œì›
            intrinsic: 2800000,        // 280ë§Œì›
            asset: 2000000,            // 200ë§Œì›
            inheritance_tax: 3500000   // 350ë§Œì›
        };

        let projectId, method, totalPaymentAmount;

        async function loadPaymentPage() {
            try {
                // URL íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
                const urlParams = new URLSearchParams(window.location.search);
                projectId = urlParams.get('projectId');
                method = urlParams.get('method');

                if (!projectId || !method) {
                    alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
                    window.location.href = '../index.html';
                    return;
                }

                // í‰ê°€ë²• ìƒíƒœ í™•ì¸
                const methodStatus = await checkMethodStatus(projectId, method);
                if (methodStatus.status !== STATUS.IN_PROGRESS || methodStatus.step !== 13) {
                    alert('ê²°ì œ ë‹¨ê³„ê°€ ì•„ë‹™ë‹ˆë‹¤.');
                    window.location.href = '../index.html';
                    return;
                }

                // í”„ë¡œì íŠ¸ ì •ë³´ ì¡°íšŒ
                const { data: project, error } = await supabase
                    .from('projects')
                    .select('*')
                    .eq('project_id', projectId)
                    .single();

                if (error || !project) {
                    console.error('í”„ë¡œì íŠ¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    alert('í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // í”„ë¡œì íŠ¸ ì •ë³´ í‘œì‹œ
                displayProjectInfo(project);

                // ê²°ì œ ê¸ˆì•¡ ê³„ì‚° ë° í‘œì‹œ
                calculateAndDisplayPayment();

                // ì‚¬ì´ë“œë°” ë Œë”ë§ (13ë‹¨ê³„ - ê²°ì œí•˜ê¸°)
                injectSidebar(
                    'sidebar-container',
                    13,                         // í˜„ì¬ ë‹¨ê³„
                    STATUS.IN_PROGRESS,         // ì§„í–‰ ì¤‘
                    method,                     // í‰ê°€ë²•
                    projectId                   // í”„ë¡œì íŠ¸ ID
                );

                // ë¡œë”© ìˆ¨ê¹€
                document.getElementById('loadingState').style.display = 'none';
                showCards();

            } catch (error) {
                console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function displayProjectInfo(project) {
            document.getElementById('projectIdDisplay').textContent = project.project_id;
            document.getElementById('companyNameDisplay').textContent = project.company_name_kr;
            document.getElementById('methodDisplay').textContent = METHOD_NAMES[method];
            document.getElementById('valuationDateDisplay').textContent = project.valuation_date || '-';

            // ìµœì¢…ì•ˆ ë³´ê¸° ë²„íŠ¼ ë§í¬ ì„¤ì •
            document.getElementById('btnViewReport').href =
                `./results/result-${method}.html?projectId=${projectId}&mode=final`;
        }

        function calculateAndDisplayPayment() {
            const basePrice = METHOD_PRICES[method] || 0;
            const vat = Math.floor(basePrice * 0.1);
            const total = basePrice + vat;

            totalPaymentAmount = total;

            // ê¸ˆì•¡ í‘œì‹œ (ì²œ ë‹¨ìœ„ ì½¤ë§ˆ)
            document.getElementById('serviceName').textContent = METHOD_NAMES[method];
            document.getElementById('baseAmount').textContent = formatCurrency(basePrice);
            document.getElementById('vatAmount').textContent = formatCurrency(vat);
            document.getElementById('totalAmount').textContent = formatCurrency(total);
            document.getElementById('depositAmount').textContent = formatCurrency(total);

            // ê²°ì œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            updatePaymentButtonText(total);
        }

        function formatCurrency(amount) {
            return 'â‚©' + amount.toLocaleString('ko-KR');
        }

        function updatePaymentButtonText(amount) {
            const btnPay = document.getElementById('btnPay');
            btnPay.textContent = `${formatCurrency(amount)} ê²°ì œí•˜ê¸°`;
        }

        function showCards() {
            document.getElementById('projectInfoCard').style.display = 'block';
            document.getElementById('reportPreviewCard').style.display = 'block';
            document.getElementById('paymentSummaryCard').style.display = 'block';
            document.getElementById('paymentMethodCard').style.display = 'block';
        }

        // ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ ì´ë²¤íŠ¸
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                // ëª¨ë“  í¼ ìˆ¨ê¹€
                document.querySelectorAll('.payment-form').forEach(form => {
                    form.classList.remove('active');
                });

                // ì„ íƒëœ í¼ë§Œ í‘œì‹œ
                const selectedMethod = e.target.value;
                document.getElementById(`form${capitalize(selectedMethod)}`).classList.add('active');

                // ì•½ê´€ ë™ì˜ ì²´í¬ í™•ì¸
                checkTermsAndEnableButton();
            });
        });

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // ì•½ê´€ ë™ì˜ ì²´í¬
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', checkTermsAndEnableButton);
        });

        function checkTermsAndEnableButton() {
            const termsPayment = document.getElementById('termsPayment').checked;
            const termsPrivacy = document.getElementById('termsPrivacy').checked;
            const termsRefund = document.getElementById('termsRefund').checked;
            const paymentMethodSelected = document.querySelector('input[name="paymentMethod"]:checked');

            const allChecked = termsPayment && termsPrivacy && termsRefund && paymentMethodSelected;
            document.getElementById('btnPay').disabled = !allChecked;
        }

        // ê²°ì œ ë²„íŠ¼ í´ë¦­
        document.getElementById('btnPay').addEventListener('click', async () => {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
            if (!selectedMethod) {
                alert('ê²°ì œ ìˆ˜ë‹¨ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                return;
            }

            const paymentMethod = selectedMethod.value;

            // ê²°ì œ ì²˜ë¦¬ (Mock)
            const confirmMessage = `${METHOD_NAMES[method]} í‰ê°€ ì„œë¹„ìŠ¤ë¥¼ ${formatCurrency(totalPaymentAmount)}ì— ê²°ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // ë¡œë”© í‘œì‹œ
            const btnPay = document.getElementById('btnPay');
            const originalText = btnPay.textContent;
            btnPay.textContent = 'ê²°ì œ ì²˜ë¦¬ ì¤‘...';
            btnPay.disabled = true;

            try {
                // ì‹¤ì œë¡œëŠ” PGì‚¬ API í˜¸ì¶œ (Mockìœ¼ë¡œ ëŒ€ì²´)
                await new Promise(resolve => setTimeout(resolve, 2000));

                // ë°±ì—”ë“œ APIë¥¼ í†µí•´ ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸
                const response = await fetch('http://localhost:8000/api/v1/valuation/update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: projectId,
                        method: method,
                        status: 'completed',
                        step: 14
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Payment status update failed');
                }

                const result = await response.json();
                console.log('Payment completed:', result);

                alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! í‰ê°€ë³´ê³ ì„œë¥¼ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');

                // 14ë‹¨ê³„ (ë³´ê³ ì„œ ìˆ˜ë ¹)ë¡œ ì´ë™
                window.location.href = `./report-download.html?projectId=${projectId}&method=${method}`;

            } catch (error) {
                console.error('ê²°ì œ ì‹¤íŒ¨:', error);
                alert('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                btnPay.textContent = originalText;
                btnPay.disabled = false;
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        loadPaymentPage();
    </script>

    <!-- ì „ì—­ í•¨ìˆ˜ -->
    <script>
        // ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬
        function copyAccountNumber() {
            const accountNumber = document.getElementById('accountNumber').textContent;
            navigator.clipboard.writeText(accountNumber).then(() => {
                alert('ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
            });
        }

        // ì•½ê´€ ì „ë¬¸ ë³´ê¸°
        function showTerms(type) {
            const titles = {
                payment: 'ê²°ì œ ëŒ€í–‰ ì„œë¹„ìŠ¤ ì•½ê´€',
                privacy: 'ê°œì¸ì •ë³´ ì œ3ì ì œê³µ ë™ì˜',
                refund: 'í™˜ë¶ˆ ê·œì •'
            };

            const contents = {
                payment: 'ê²°ì œ ëŒ€í–‰ ì„œë¹„ìŠ¤ëŠ” KGì´ë‹ˆì‹œìŠ¤, í† ìŠ¤í˜ì´ë¨¼ì¸  ë“±ì˜ PGì‚¬ë¥¼ í†µí•´ ì œê³µë©ë‹ˆë‹¤...',
                privacy: 'ê²°ì œ ì²˜ë¦¬ë¥¼ ìœ„í•´ ê·€í•˜ì˜ ê°œì¸ì •ë³´ê°€ PGì‚¬ì— ì œê³µë©ë‹ˆë‹¤...',
                refund: 'í‰ê°€ë³´ê³ ì„œ ìˆ˜ë ¹ ì „ì—ëŠ” 100% í™˜ë¶ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ìˆ˜ë ¹ í›„ì—ëŠ” í™˜ë¶ˆì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤...'
            };

            alert(`${titles[type]}\n\n${contents[type]}`);
        }
    </script>
</body>
</html>
